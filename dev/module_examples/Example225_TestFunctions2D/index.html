<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Example225_TestFunctions2D · VoronoiFVM.jl</title><meta name="title" content="Example225_TestFunctions2D · VoronoiFVM.jl"/><meta property="og:title" content="Example225_TestFunctions2D · VoronoiFVM.jl"/><meta property="twitter:title" content="Example225_TestFunctions2D · VoronoiFVM.jl"/><meta name="description" content="Documentation for VoronoiFVM.jl."/><meta property="og:description" content="Documentation for VoronoiFVM.jl."/><meta property="twitter:description" content="Documentation for VoronoiFVM.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">VoronoiFVM.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../changes/">Changes</a></li><li><a class="tocitem" href="../../method/">The Voronoi finite volume method</a></li><li><span class="tocitem">API Documentation</span><ul><li><a class="tocitem" href="../../system/">System</a></li><li><a class="tocitem" href="../../physics/">Physics &amp; special functions</a></li><li><a class="tocitem" href="../../solutions/">Solution objects</a></li><li><a class="tocitem" href="../../solver/">Built-in solver</a></li><li><a class="tocitem" href="../../post/">Postprocessing</a></li><li><a class="tocitem" href="../../quantities/">Quantities</a></li><li><a class="tocitem" href="../../misc/">Miscellaneous</a></li><li><a class="tocitem" href="../../internal/">Internal API</a></li><li><a class="tocitem" href="../../allindex/">Index</a></li><li><a class="tocitem" href="../../devel/">Development hints</a></li></ul></li><li><span class="tocitem">Tutorial Notebooks</span><ul><li><a class="tocitem" href="../../notebooks/">About the notebooks</a></li><li><a class="tocitem" href="../../pluto_examples/outflow/">Outflow boundary conditions</a></li><li><a class="tocitem" href="../../pluto_examples/flux-reconstruction/">Obtaining vector fields</a></li><li><a class="tocitem" href="../../pluto_examples/interfaces1d/">Internal interfaces (1D)</a></li><li><a class="tocitem" href="../../pluto_examples/problemcase/">A case for caution</a></li><li><a class="tocitem" href="../../pluto_examples/nonlinear-solvers/">Nonlinear solver control</a></li><li><a class="tocitem" href="../../pluto_examples/api-update/">API Updates</a></li></ul></li><li><span class="tocitem">Examples</span><ul><li><a class="tocitem" href="../../runexamples/">About the examples</a></li><li><a class="tocitem" href="../Example001_Solvers/">Example001_Solvers</a></li><li><a class="tocitem" href="../Example002_EdgeReaction/">Example002_EdgeReaction</a></li><li><a class="tocitem" href="../Example101_Laplace1D/">Example101_Laplace1D</a></li><li><a class="tocitem" href="../Example102_StationaryConvectionDiffusion1D/">Example102_StationaryConvectionDiffusion1D</a></li><li><a class="tocitem" href="../Example103_ConvectionDiffusion1D/">Example103_ConvectionDiffusion1D</a></li><li><a class="tocitem" href="../Example105_NonlinearPoisson1D/">Example105_NonlinearPoisson1D</a></li><li><a class="tocitem" href="../Example106_NonlinearDiffusion1D/">Example106_NonlinearDiffusion1D</a></li><li><a class="tocitem" href="../Example107_NonlinearStorage1D/">Example107_NonlinearStorage1D</a></li><li><a class="tocitem" href="../Example110_ReactionDiffusion1D_TwoSpecies/">Example110<em>ReactionDiffusion1D</em>TwoSpecies</a></li><li><a class="tocitem" href="../Example115_HeterogeneousCatalysis1D/">Example115_HeterogeneousCatalysis1D</a></li><li><a class="tocitem" href="../Example120_ThreeRegions1D/">Example120_ThreeRegions1D</a></li><li><a class="tocitem" href="../Example121_PoissonPointCharge1D/">Example121_PoissonPointCharge1D</a></li><li><a class="tocitem" href="../Example125_TestFunctions1D/">Example125_TestFunctions1D</a></li><li><a class="tocitem" href="../Example150_Impedance1D/">Example150_Impedance1D</a></li><li><a class="tocitem" href="../Example151_Impedance1D/">Example151_Impedance1D</a></li><li><a class="tocitem" href="../Example160_UnipolarDriftDiffusion1D/">Example160_UnipolarDriftDiffusion1D</a></li><li><a class="tocitem" href="../Example201_Laplace2D/">Example201_Laplace2D</a></li><li><a class="tocitem" href="../Example203_CoordinateSystems/">Example203_CoordinateSystems</a></li><li><a class="tocitem" href="../Example204_HagenPoiseuille/">Example204_HagenPoiseuille</a></li><li><a class="tocitem" href="../Example205_StagnationPoint/">Example205_StagnationPoint</a></li><li><a class="tocitem" href="../Example206_JouleHeat/">Example206_JouleHeat</a></li><li><a class="tocitem" href="../Example207_NonlinearPoisson2D/">Example207_NonlinearPoisson2D</a></li><li><a class="tocitem" href="../Example210_NonlinearPoisson2D_Reaction/">Example210<em>NonlinearPoisson2D</em>Reaction</a></li><li><a class="tocitem" href="../Example215_NonlinearPoisson2D_BoundaryReaction/">Example215<em>NonlinearPoisson2D</em>BoundaryReaction</a></li><li><a class="tocitem" href="../Example220_NonlinearPoisson2D_BoundarySpecies/">Example220<em>NonlinearPoisson2D</em>BoundarySpecies</a></li><li class="is-active"><a class="tocitem" href>Example225_TestFunctions2D</a></li><li><a class="tocitem" href="../Example226_BoundaryIntegral/">Example226_BoundaryIntegral</a></li><li><a class="tocitem" href="../Example230_BoundaryFlux/">Example230_BoundaryFlux</a></li><li><a class="tocitem" href="../Example301_Laplace3D/">Example301_Laplace3D</a></li><li><a class="tocitem" href="../Example311_HeatEquation_BoundaryDiffusion/">Example311<em>HeatEquation</em>BoundaryDiffusion</a></li><li><a class="tocitem" href="../Example405_GenericOperator/">Example405_GenericOperator</a></li><li><a class="tocitem" href="../Example406_WeirdReaction/">Example406_WeirdReaction</a></li><li><a class="tocitem" href="../Example410_ManySpecies/">Example410_ManySpecies</a></li><li><a class="tocitem" href="../Example420_DiscontinuousQuantities/">Example420_DiscontinuousQuantities</a></li><li><a class="tocitem" href="../Example421_AbstractQuantities_TestFunctions/">Example421<em>AbstractQuantities</em>TestFunctions</a></li><li><a class="tocitem" href="../Example422_InterfaceQuantities/">Example422_InterfaceQuantities</a></li><li><a class="tocitem" href="../Example424_AbstractQuantitiesInit/">Example424_AbstractQuantitiesInit</a></li><li><a class="tocitem" href="../Example430_ParameterDerivativesStationary/">Example430_ParameterDerivativesStationary</a></li><li><a class="tocitem" href="../Example510_Mixture/">Example510_Mixture</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Examples</a></li><li class="is-active"><a href>Example225_TestFunctions2D</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Example225_TestFunctions2D</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/j-fu/VoronoiFVM.jl" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id=":-Terminal-flux-calculation-via-test-functions,-nD"><a class="docs-heading-anchor" href="#:-Terminal-flux-calculation-via-test-functions,-nD">225: Terminal flux calculation via test functions, nD</a><a id=":-Terminal-flux-calculation-via-test-functions,-nD-1"></a><a class="docs-heading-anchor-permalink" href="#:-Terminal-flux-calculation-via-test-functions,-nD" title="Permalink"></a></h1><p>(<a href="../Example225_TestFunctions2D.jl">source code</a>)</p><p>After calculating solutions based on the finite volume method, it may be interesting to obtain information about the solution besides of the graphical representation.</p><p>Here, we focus on the following data:</p><ul><li>integrals of the solution</li><li>flux through parts of the boundary</li></ul><p>Let us define the following reaction - diffusion system in a domain <span>$\Omega$</span>:</p><p class="math-container">\[\begin{aligned}
\partial_t u_1 - \nabla \cdot \nabla u_1 + r(u_1, u_2) &amp;= f=1.0\\
\partial_t u_2 - \nabla \cdot \nabla u_1 - r(u_1, u_2) &amp;= 0
\end{aligned}\]</p><p>with boundary conditions <span>$u_2=0$</span> on <span>$\Gamma_2\subset\partial\Omega$</span> and <span>$r(u_1,u_2)=u_1 + 0.1 u_2$</span></p><p>The source <span>$f$</span> creates species <span>$u_1$</span> which reacts to <span>$u_2$</span>, <span>$u_2$</span> then leaves the domain at boundary <span>$\Gamma_2$</span>.</p><h3 id="Stationary-problem"><a class="docs-heading-anchor" href="#Stationary-problem">Stationary problem</a><a id="Stationary-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Stationary-problem" title="Permalink"></a></h3><p>For the stationary problem, we have the following flux balances derived from the equations and from Gauss theorem:</p><p class="math-container">\[\begin{aligned}
\int_\Omega r(u_1,u_2) d\omega &amp;= \int_\Omega f d\omega \\
\int_\Omega -r(u_1,u_2) d\omega &amp;= \int_{\Gamma_2} \nabla u \cdot \vec n ds \\
\end{aligned}\]</p><p>The volume integrals can be approximated based on the finite volume subdivision <span>$\Omega=\cup_{i\in \mathcal N} \omega_i$</span>:</p><p class="math-container">\[\begin{aligned}
\int_\Omega r(u_1,u_2) d\omega &amp;\approx \sum_{i\in \mathcal N} |\omega_i| r(u_{1,i},u_{2,i})\\
\int_\Omega f d\omega &amp;\approx \sum_{i\in \mathcal N} |\omega_i| f_i
\end{aligned}\]</p><p>But what about  the boundary integral ?  Here, we use a  trick to cast the surface  integral to the  integral to  a volume integral  with the help of a test function:</p><p>Let <span>$T(x)$</span> be the solution of the Laplace problem <span>$-\nabla^2 T =0$</span> in <span>$\Omega$</span> and the boundary conditions</p><p class="math-container">\[\begin{aligned}
T &amp;=0 \quad \text{at}\; \Gamma_4\\
T &amp;=1 \quad \text{at}\; \Gamma_2\\
\partial_n T &amp;=0\quad \text{at}\;  \Gamma_1,\Gamma_3
\end{aligned}\]</p><p>Write <span>$\vec j=-\nabla u$</span>. and assume <span>$\nabla\cdot \vec j + r =f$</span>.</p><p class="math-container">\[\begin{aligned}
\int_{\Gamma_2} \vec j \cdot \vec n ds&amp;=\int_{\Gamma_2} T\vec j \cdot \vec n ds \quad \text{due to}\; T=1\; \text{on}\; \Gamma_2\\
 &amp;=\int_{\partial\Omega}  T\vec j \cdot \vec n ds\quad \text{due to}\; T=0\; \text{on}\; \Gamma_4, \quad\vec j\cdot \vec n=0\; \text{on}\; \Gamma_1, \Gamma_3\\
&amp;= \int_\Omega \nabla \cdot (T \vec j) d\omega \quad \text{(Gauss)}\\
&amp;= \int_\Omega \nabla T \cdot \vec j d\omega + \int_\Omega T \nabla\cdot j d\omega\\
&amp;=  \int_\Omega \nabla T \cdot \vec j d\omega + \int_\Omega T(f-r)dω\\
\end{aligned}\]</p><p>and we approximate</p><p class="math-container">\[\begin{aligned}
\int_\Omega \nabla T \cdot \vec j d\omega \approx \sum_{k,l}
\frac{|\omega_k\cap\omega_l|}{h_{k,l}}g(u_k, u_l) (T_k-T_l)
\end{aligned}\]</p><p>where the sum runs over pairs of neighboring control volumes.</p><p>The <code>integrate</code> method with a  test function parameter returns a value for each species, the sign convention assumes that species leaving the domain lead to negative values.</p><h3 id="Transient-problem"><a class="docs-heading-anchor" href="#Transient-problem">Transient problem</a><a id="Transient-problem-1"></a><a class="docs-heading-anchor-permalink" href="#Transient-problem" title="Permalink"></a></h3><p>The amount  of species created via  the source term (measured  in <code>F</code>) integrated  over time  should be  equal to  the sum  of the  amount of species left in  the domain at the  very end of the  evolution and the amount of species which left the domain:</p><p class="math-container">\[\int_{t_0}^{t_{end}} \int_\Omega f d\omega dt= \int_\Omega (u_1+u_2)dω + \int_{t_0}^{t_{end}} \int_{\Gamma_2} \nabla u_2 \cdot \vec n ds\]</p><p>Literature references:</p><ul><li>H. Gajewski &quot;Analysis und Numerik von Ladungstransport in Halbleitern&quot;, WIAS Berlin, Report No.6</li><li>Yoder, P. D., K. Gärtner, and W. Fichtner. &quot;A generalized Ramo–Shockley theorem for classical to quantum transport at arbitrary frequencies.&quot; Journal of Applied Physics 79.4 (1996): 1951-1954.</li><li>P. Farrell, N. Rotundo, D. H. Doan, M. Kantner, J. Fuhrmann, and T. Koprucki, &quot;Numerical methods for drift-diffusion models&quot;, in Handbook of optoelectronic device modeling and simulation: Lasers, modulators, photodetectors, solar cells, and numerical methods, vol. 2, J. Piprek, Ed. Boca Raton: CRC Press, 2017, pp. 733–771.</li></ul><pre><code class="language-julia hljs">module Example225_TestFunctions2D

using VoronoiFVM, GridVisualize, ExtendableGrids

function main(; n = 10, Plotter = nothing, verbose = false, unknown_storage = :sparse, assembly = :edgewise,
              dim = 2, tend = 5, dt = 0.2)
    n = [101, 21, 5]
    X = collect(range(0.0, 1; length = n[dim]))
    if dim == 1
        grid = simplexgrid(X)
        Γ_where_T_equal_1 = [2]
        Γ_where_T_equal_0 = [1]
    elseif dim == 2
        grid = simplexgrid(X, X)
        Γ_where_T_equal_1 = [2]
        Γ_where_T_equal_0 = [4]
    elseif dim == 3
        grid = simplexgrid(X, X, X)
        Γ_where_T_equal_1 = [2]
        Γ_where_T_equal_0 = [4]
    end

    function storage(f, u, node)
        f .= u
    end

    function flux(f, u, edge)
        f[1] = u[1, 1] - u[1, 2]
        f[2] = u[2, 1] - u[2, 2]
    end

    r(u1, u2) = u1 - 0.1 * u2

    function reaction(f, u, node)
        f[1] = r(u[1], u[2])
        f[2] = -r(u[1], u[2])
    end

    function source(f, node)
        f[1] = 1.0
    end

    physics = VoronoiFVM.Physics(; flux = flux,
                                 storage = storage,
                                 reaction = reaction,
                                 source = source)

    system = VoronoiFVM.System(grid, physics; assembly = assembly)

    enable_species!(system, 1, [1])
    enable_species!(system, 2, [1])
    boundary_dirichlet!(system, 2, 2, 0.0)

    sol = solve(system; inival = 0.0)

    vis = GridVisualizer(; Plotter = Plotter, layout = (1, 2), resolution = (600, 300),
                         fignumber = 1)
    scalarplot!(vis[1, 1], grid, sol[1, :]; flimits = (0, 1.5), title = &quot;u_1&quot;)
    scalarplot!(vis[1, 2], grid, sol[2, :]; flimits = (0, 1.5), title = &quot;u_2&quot;, show = true)

    &quot;&quot;&quot;
        The `integrate` method of `VoronoiFVM`  provides a possibility to calculate
        the volume integral of a function of a solution as described above.
        It returns a `num_specie` x `num_regions` matrix of the integrals
        of the function of the unknowns over the different subdomains (here, we have only one):
    &quot;&quot;&quot;

    &quot;&quot;&quot;
        Amount of u_1 and u_2 in the domain aka integral over identity storage function:
    &quot;&quot;&quot;
    U = integrate(system, storage, sol)

    &quot;&quot;&quot;
    Amount of species created by source term per unit time:
    &quot;&quot;&quot;
    F = integrate(system, (f, u, node) -&gt; source(f, node), sol)

    &quot;&quot;&quot;
    Amount of  reaction per unit time:
    &quot;&quot;&quot;
    R = integrate(system, reaction, sol)

    tf = TestFunctionFactory(system)
    T = testfunction(tf, Γ_where_T_equal_0, Γ_where_T_equal_1)

    I = integrate(system, T, sol)

    t0 = 0.0

    control = fixed_timesteps!(VoronoiFVM.NewtonControl(), dt)

    tsol = solve(system; inival = 0.0, times = [t0, tend], control)

    vis1 = GridVisualizer(; Plotter = Plotter, layout = (1, 2), resolution = (600, 300),
                          fignumber = 4)

    for i = 1:length(tsol)
        sol = tsol[i]
        scalarplot!(vis1[1, 1], grid, sol[1, :]; flimits = (0, 1.5), clear = true)
        scalarplot!(vis1[1, 2], grid, sol[2, :]; flimits = (0, 1.5), show = true)
    end

    outflow_rate = Float64[]
    for i = 2:length(tsol)
        ofr = integrate(system, T, tsol[i], tsol[i - 1], tsol.t[i] - tsol.t[i - 1])
        push!(outflow_rate, ofr[2])
    end

    vis2 = GridVisualizer(; Plotter = Plotter, layout = (1, 1), resolution = (600, 300),
                          fignumber = 2)
    scalarplot!(vis2[1, 1], [0, tend], -[I[2], I[2]]; label = &quot;stationary&quot;, clear = true)
    scalarplot!(vis2[1, 1], tsol.t[2:end], -outflow_rate; label = &quot;transient&quot;, show = true)

    all_outflow = 0.0
    for i = 1:(length(tsol) - 1)
        all_outflow -= outflow_rate[i] * (tsol.t[i + 1] - tsol.t[i])
    end

    Uend = integrate(system, storage, tsol[end])
    isapprox(F[1], R[1]; rtol = 1.0e-12) ? true : return false
    isapprox(I[1], 0.0; atol = 1.0e-12) ? true : return false
    isapprox(R[2], I[2]; rtol = 1.0e-12) ? true : return false
    isapprox(F[1] * (tend - t0), (Uend[1] + Uend[2] + all_outflow); rtol = 1.0e-12) ? true :
    return false
end

using Test
function runtests()
    @test main(; dim = 1, unknown_storage = :sparse, assembly = :edgewise)
    @test main(; dim = 1, unknown_storage = :dense, assembly = :edgewise)
    @test main(; dim = 2, unknown_storage = :sparse, assembly = :edgewise)
    @test main(; dim = 2, unknown_storage = :dense, assembly = :edgewise)
    @test main(; dim = 3, unknown_storage = :sparse, assembly = :edgewise)
    @test main(; dim = 3, unknown_storage = :dense, assembly = :edgewise)

    @test main(; dim = 1, unknown_storage = :sparse, assembly = :cellwise)
    @test main(; dim = 1, unknown_storage = :dense, assembly = :cellwise)
    @test main(; dim = 2, unknown_storage = :sparse, assembly = :cellwise)
    @test main(; dim = 2, unknown_storage = :dense, assembly = :cellwise)
    @test main(; dim = 3, unknown_storage = :sparse, assembly = :cellwise)
    @test main(; dim = 3, unknown_storage = :dense, assembly = :cellwise)
end

end</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Example220_NonlinearPoisson2D_BoundarySpecies/">« Example220<em>NonlinearPoisson2D</em>BoundarySpecies</a><a class="docs-footer-nextpage" href="../Example226_BoundaryIntegral/">Example226_BoundaryIntegral »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Wednesday 22 November 2023 10:56">Wednesday 22 November 2023</span>. Using Julia version 1.9.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
